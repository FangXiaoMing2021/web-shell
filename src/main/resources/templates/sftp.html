<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>web sftp</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="shortcut icon" th:href="@{/static/img/favicon.ico}"/>
    <link rel="stylesheet" th:href="@{/static/css/webShell.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/jstree/style.min.css}"/>
    <script type="text/javascript" th:src="@{/static/js/jquery-3.5.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/static/js/web-socket.js}"></script>
    <script type="text/javascript" th:src="@{/static/js/web-shell.js}"></script>
    <script type="text/javascript" th:src="@{/static/js/jstree.min.js}"></script>
</head>
<body>
    <div class="sftp-container">
        <div class="sftp-file-tree-div">
            <input id="current_path" placeholder="当前目录" value="/">
            <div id="file_tree" class="sftp-file-tree"></div>
        </div>
        <div id="file_detail" class="sftp-file-detail">
            <table border="0" class="file-detail-table">
                <tr>
                    <th>文件名</th>
                    <th>文件类型</th>
                    <th>文件属性</th>
                    <th>目录/链接个数</th>
                    <th>所有者</th>
                    <th>组</th>
                    <th>文件大小</th>
                    <th>修改时间</th>
                </tr>
            </table>
        </div>
        <div id="message_console" class="sftp-message-console"></div>
    </div>
</body>
<script th:inline="javascript">
$(function () {
    let url = window.location.href;
    let urlParams = window.location.search;
    history.replaceState(null, null, url.replace(urlParams, ""))
    const login = [[${login}]];
    if (!login) {
        alert("登录失败，请重新连接SFTP服务！")
    }
    function showTips(msg) {
        $("#message_console").html(new Date().toLocaleTimeString() + "：" + msg);
    }
    function checkErr(data) {
        if (data.code === 200) {
            showTips("查询成功！");
        } else {
            showTips("查询失败！");
        }
    }
    function getFileTree(instance, selectedNode) {
        $.ajax({
            url : "/sftp/getFileTree",
            dataType : "json",
            data: { 'path': selectedNode.id },
            type : "get",
            success : function(res) {
                console.info(res);
                checkErr(res)
                let fileTree = res.data
                if(fileTree && fileTree.length > 0) {
                    selectedNode.children = [];
                    for (const i in fileTree) {
                        let item = fileTree[i];
                        instance.create_node(selectedNode, item, "last");
                    }
                    instance.open_node(selectedNode);
                    //全不选择
                    instance.deselect_all();
                    loadTableData(fileTree);
                }else{
                    showTips("暂无数据！");
                    $(".file-detail-table .data-cell").remove();
                }
            }
        });
    }
    let $fileTree = $('#file_tree');
    let $currentPathInput = $("#current_path");
    function loadTableData(data) {
        let fileDetail = "";
        $(".file-detail-table .data-cell").remove();
        for (const i in data) {
            let item = data[i];
            let className = "odd-row";
            if(i % 2 === 0){
                className = "even-row";
            }
            let icon = item.icon;
            if(icon && !icon.startsWith('jstree')){
                icon = "' style='background-image: url(" + icon
                    + ");background-position: center center;background-size: auto;'";
            }
            fileDetail += "<tr class='data-cell " + className + "'>";
            fileDetail += "<td class='file-name jstree-default' id='" + item.id + "'>" +
                "<i class='jstree-icon " + icon + "'></i>"+ item.text +"</td>";
            fileDetail += "<td>"+ item.fileType +"</td>";
            fileDetail += "<td>"+ item.fileAttr +"</td>";
            fileDetail += "<td>"+ item.numberOfDir +"</td>";
            fileDetail += "<td>"+ item.owner +"</td>";
            fileDetail += "<td>"+ item.group +"</td>";
            fileDetail += "<td>"+ item.size +"</td>";
            fileDetail += "<td>"+ item.modifiedDate +"</td></tr>";
        }
        $(".file-detail-table").append(fileDetail);
        $('.data-cell .file-name').bind('click', function() {
            $currentPathInput.val($(this).attr('id'))
            $currentPathInput.focus()
        }).bind('dblclick', function() {
            let tree = $fileTree.jstree(true);
            tree.select_node($(this).attr('id'));
        });
    }
    // 根目录
    let rootDirectory = { "id": "/", "parent": "#", "text": "/", 'state': { 'opened': true }}

    $fileTree.on("changed.jstree", function (e, data) {
        if(data.selected.length) {
            let selected = data.instance.get_node(data.selected[0])
            console.log('The selected node is: ' + selected.id);
            $currentPathInput.val(selected.id)
            // 只查询文件夹的下一级文件
            if ("jstree-folder" === selected.icon) {
                getFileTree(data.instance, selected)
            }
        }
    }).jstree({
        "core" : {
            "multiple" : false,
            'check_callback': true,
            'data' : function (obj, callback){
                $.ajax({
                    url : "/sftp/getFileTree",
                    dataType : "json",
                    data: { path: '/' },
                    type : "get",
                    success : function(res) {
                        console.info(res);
                        checkErr(res)
                        let fileTree = res.data
                        if(fileTree) {
                            loadTableData(fileTree);
                            fileTree.unshift(rootDirectory)
                            callback.call(this, fileTree);
                        }else{
                            showTips("暂无数据！");
                            $(".file-detail-table .data-cell").remove();
                        }
                    }
                });
            }
        },
        "checkbox" : {
            "keep_selected_style" : false
        },
        "plugins" : [ "wholerow", "checkbox" ]
    });

    /**
     * 选中node
     * @param {String} nodeId 节点id
     * @param {String} pNodeId 父节点id（可选）
     */
    function selectNode(nodeId, pNodeId) {
        let tree = $fileTree.jstree(true);
        if (tree.get_node(nodeId)){
            tree.select_node(nodeId);
            return true;
        } else if (pNodeId && tree.get_node(pNodeId)){
            tree.select_node(pNodeId);
            if (nodeId !== pNodeId) {
                $currentPathInput.val(nodeId)
                $currentPathInput.focus()
            }
            return true;
        } else {
            return selectNode(nodeId, nodeId.substring(0, nodeId.lastIndexOf('/')))
        }
    }
    $currentPathInput.bind("keypress", function(event){
        if(event.keyCode === 13){
            // 删除最后一个/
            let val = $(this).val().replace(/(\/*$)/g,"");
            console.log(val)
            if (val) {
                selectNode(val);
            }
        }
    })
});
</script>
</html>
